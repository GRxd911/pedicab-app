<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TMO Dashboard | Dumaguete Pedicab</title>
    <link rel="stylesheet" href="../shared/css/style.css">
    <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet">

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- Leaflet Routing Machine CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
    <style>
        body {
            display: flex;
            min-height: 100vh;
            background: #f4f7fe;
        }

        /* Sidebar Styles */
        .sidebar {
            width: 260px;
            background: #2D3192;
            /* matches the blue in your image */
            color: white;
            padding: 24px;
            display: flex;
            flex-direction: column;
            position: fixed;
            height: 100vh;
            z-index: 1000;
        }

        .sidebar-header {
            margin-bottom: 40px;
        }

        .sidebar-header h2 {
            font-size: 20px;
            font-weight: 700;
            margin: 0;
        }

        .sidebar-header p {
            font-size: 12px;
            opacity: 0.7;
        }

        .nav-links {
            list-style: none;
            flex: 1;
        }

        .nav-item {
            margin-bottom: 8px;
        }

        .nav-link {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            color: rgba(255, 255, 255, 0.7);
            text-decoration: none;
            border-radius: 12px;
            transition: all 0.3s;
            font-weight: 500;
        }

        .nav-link:hover,
        .nav-link.active {
            background: #3F44B5;
            color: white;
        }

        .nav-link i {
            font-size: 20px;
        }

        .nav-link {
            position: relative;
        }

        .nav-dot {
            width: 8px;
            height: 8px;
            background: #ef4444;
            border-radius: 50%;
            position: absolute;
            top: 12px;
            right: 15px;
            box-shadow: 0 0 8px rgba(239, 68, 68, 0.6);
            display: none;
        }

        .logout-link {
            margin-top: auto;
            color: white;
            padding: 12px 16px;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 500;
        }

        /* Main Content */
        .main-content {
            margin-left: 260px;
            flex: 1;
            padding: 40px;
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 40px;
        }

        .view-switcher {
            display: flex;
            background: #eef2f6;
            padding: 4px;
            border-radius: 12px;
            gap: 4px;
        }

        .switcher-btn {
            padding: 8px 16px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: 500;
            font-size: 13px;
            background: transparent;
            color: var(--text-muted);
        }

        .switcher-btn.active {
            background: white;
            color: var(--primary);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }

        .stat-card {
            background: white;
            padding: 24px;
            border-radius: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.03);
            position: relative;
        }

        .stat-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            margin-bottom: 16px;
        }

        .stat-info h3 {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .stat-info p {
            color: var(--text-muted);
            font-size: 14px;
        }

        .stat-trend {
            position: absolute;
            top: 24px;
            right: 24px;
            font-size: 13px;
            font-weight: 600;
        }

        .trend-up {
            color: #10b981;
        }

        /* Tables/Lists Section */
        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 32px;
        }

        .card-panel {
            background: white;
            padding: 24px;
            border-radius: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.03);
        }

        .card-panel h2 {
            font-size: 18px;
            margin-bottom: 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .activity-item {
            display: flex;
            gap: 16px;
            padding: 16px 0;
            border-bottom: 1px solid #f1f5f9;
        }

        .activity-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-top: 6px;
            background: var(--primary);
        }

        .driver-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 0;
            border-bottom: 1px solid #f1f5f9;
        }

        .badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }

        .badge-success {
            background: #d1fae5;
            color: #065f46;
        }

        .badge-warning {
            background: #fef3c7;
            color: #92400e;
        }

        .badge-primary {
            background: #e0e7ff;
            color: #3730a3;
        }

        /* Modal Styles */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 10000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(4px);
        }

        .modal-card {
            background: white;
            padding: 32px;
            border-radius: 20px;
            width: 400px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        .modal-card h2 {
            margin-bottom: 24px;
            color: #2D3192;
        }

        .modal-form-group {
            margin-bottom: 16px;
        }

        .modal-form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            font-size: 14px;
        }

        .modal-input {
            width: 100%;
            padding: 12px;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            font-family: inherit;
        }

        .modal-actions {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }

        .modal-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
        }

        .btn-confirm {
            background: #2D3192;
            color: white;
        }

        .btn-cancel {
            background: #f1f5f9;
            color: var(--text-muted);
        }
    </style>
</head>

<body>
    <!-- Mobile Warning Overlay -->
    <div id="mobile-warning"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #2D3192; color: white; z-index: 9999; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 30px;">
        <i class='bx bx-desktop' style="font-size: 80px; margin-bottom: 20px;"></i>
        <h1 style="font-size: 24px; margin-bottom: 10px;">PC Dashboard Only</h1>
        <p style="opacity: 0.8; font-size: 16px;">The TMO Management System is designed for professional desktop
            workstations. Please access this page from the Traffic Management Office PC.</p>
        <button class="switcher-btn" onclick="window.location.href='commuter-app.html'">Passenger App</button>
        <button onclick="window.location.href='signin.html'"
            style="margin-top: 30px; padding: 12px 24px; border: none; border-radius: 12px; font-weight: 600; cursor: pointer;">Go
            Back to App</button>
    </div>

    <script>
        if (window.innerWidth < 768) {
            document.getElementById('mobile-warning').style.display = 'flex';
        }
    </script>
    <aside class="sidebar">
        <div class="sidebar-header">
            <h2>TMO Dashboard</h2>
            <p>Dumaguete City</p>
        </div>
        <ul class="nav-links">
            <li class="nav-item"><a href="#" class="nav-link active"><i class='bx bxs-dashboard'></i> Dashboard</a></li>
            <li class="nav-item"><a href="#" class="nav-link"><i class='bx bxs-car'></i> Drivers</a></li>
            <li class="nav-item"><a href="#" class="nav-link"><i class='bx bxs-user-detail'></i> Users</a></li>
            <li class="nav-item">
                <a href="#" class="nav-link" id="emergencies-nav" style="color: #e11d48;">
                    <i class='bx bxs-error-alt'></i> Emergencies
                    <span id="emergency-dot" class="nav-dot"></span>
                </a>
            </li>
            <li class="nav-item"><a href="#" class="nav-link"><i class='bx bx-line-chart'></i> Analytics</a></li>
            <li class="nav-item"><a href="#" class="nav-link" id="broadcasting-nav"><i class='bx bx-broadcast'></i>
                    Broadcasting</a></li>
            <li class="nav-item"><a href="#" class="nav-link"><i class='bx bx-cog'></i> Settings</a></li>
        </ul>
        <a href="#" onclick="window.logout()" class="logout-link"><i class='bx bx-log-out'></i> Logout</a>
    </aside>

    <main class="main-content">
        <!-- Emergency Alert Overlay -->
        <div id="emergency-alert"
            style="display: none; background: #e11d48; color: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; animation: pulse-red 1.5s infinite; border: 4px solid #9f1239;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div style="display: flex; align-items: center; gap: 15px;">
                    <i class='bx bxs-error-alt' style="font-size: 40px;"></i>
                    <div>
                        <h2 style="margin: 0; color: white; font-size: 24px;">EMERGENCY SOS ALERT</h2>
                        <p id="emergency-details" style="margin: 5px 0 0; font-weight: 600;">Loading details...</p>
                    </div>
                </div>
                <button onclick="dismissEmergency()"
                    style="background: white; color: #e11d48; border: none; padding: 10px 20px; border-radius: 8px; font-weight: 700; cursor: pointer;">ACKNOWLEDGE</button>
            </div>
        </div>

        <style>
            @keyframes pulse-red {
                0% {
                    box-shadow: 0 0 0 0 rgba(225, 29, 72, 0.7);
                }

                70% {
                    box-shadow: 0 0 0 20px rgba(225, 29, 72, 0);
                }

                100% {
                    box-shadow: 0 0 0 0 rgba(225, 29, 72, 0);
                }
            }
        </style>
        <div id="dashboard-view">
            <div class="header-top">
                <div>
                    <h1>System Overview</h1>
                    <p style="color: var(--text-muted);">Real-time monitoring and management</p>
                </div>
            </div>

            <!-- City-Wide Tracking Map -->
            <div
                style="background: white; border-radius: 20px; padding: 20px; margin-bottom: 24px; box-shadow: 0 4px 15px rgba(0,0,0,0.05);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                    <div>
                        <h2 style="font-size: 18px; font-weight: 700; margin: 0; color: #2D3192;">
                            <i class='bx bxs-map'></i> Live City Map
                        </h2>
                        <p style="font-size: 13px; color: var(--text-muted); margin: 4px 0 0;">Real-time driver
                            locations
                            and active rides</p>
                    </div>
                    <div style="display: flex; gap: 16px; font-size: 12px;">
                        <div style="display: flex; align-items: center; gap: 6px;">
                            <div style="width: 12px; height: 12px; background: #10b981; border-radius: 50%;"></div>
                            <span>Online Drivers</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 6px;">
                            <div style="width: 12px; height: 12px; background: #3b82f6; border-radius: 50%;"></div>
                            <span>Active Rides</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 6px;">
                            <div style="width: 12px; height: 12px; background: #dc2626; border-radius: 50%;"></div>
                            <span>SOS Alerts</span>
                        </div>
                    </div>
                </div>
                <div id="tmo-map" style="width: 100%; height: 500px; border-radius: 12px; overflow: hidden;"></div>
            </div>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon" style="background: rgba(79, 70, 229, 0.1); color: var(--primary);">
                        <i class='bx bxs-car'></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="active-drivers-count">0</h3>
                        <p>Active Drivers</p>
                    </div>
                    <div class="stat-trend trend-up">0%</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="background: rgba(139, 92, 246, 0.1); color: #8b5cf6;">
                        <i class='bx bxs-group'></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="registered-users-count">0</h3>
                        <p>Registered Users</p>
                    </div>
                    <div class="stat-trend trend-up">0%</div>
                </div>
                <div class="stat-card" style="display: none;">
                    <div class="stat-icon" style="background: rgba(14, 165, 233, 0.1); color: #0ea5e9;">
                        <i class='bx bxs-navigation'></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="trips-today-count">0</h3>
                        <p>Trips Today</p>
                    </div>
                    <div class="stat-trend trend-up">0%</div>
                </div>
                <div class="stat-card" style="border: 2px solid #fee2e2;">
                    <div class="stat-icon" style="background: rgba(225, 29, 72, 0.1); color: #e11d48;">
                        <i class='bx bxs-error-alt'></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="active-emergencies-count">0</h3>
                        <p>Active SOS</p>
                    </div>
                    <div class="stat-trend" style="color: #e11d48;">High Priority</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="background: rgba(245, 158, 11, 0.1); color: #f59e0b;">
                        <i class='bx bxs-badge-check'></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="pending-verification-count">0</h3>
                        <p>Pending Verification</p>
                    </div>
                    <div class="stat-trend trend-up">Action Needed</div>
                </div>
            </div>

            <div class="dashboard-grid">
                <div class="card-panel">
                    <h2>Active Drivers</h2>
                    <div id="active-drivers-list">
                        <p style="text-align: center; color: var(--text-muted); padding: 20px;">No active drivers on the
                            road.</p>
                    </div>
                </div>

                <div class="card-panel">
                    <h2>Recent Activity</h2>
                    <div id="recent-activity-list">
                        <p style="text-align: center; color: var(--text-muted); padding: 20px;">No recent system
                            activity.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Drivers Management View -->
        <div id="drivers-view" style="display: none;">
            <div class="card-panel" style="width: 100%;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                    <h2>Driver Management</h2>
                    <div class="view-switcher">
                        <button class="switcher-btn active" onclick="filterDrivers('all')">All</button>
                        <button class="switcher-btn" onclick="filterDrivers('pending')">Pending</button>
                        <button class="switcher-btn" onclick="filterDrivers('verified')">Verified</button>
                    </div>
                </div>
                <div class="table-container">
                    <table style="width: 100%; border-collapse: collapse; text-align: left;">
                        <thead>
                            <tr style="border-bottom: 2px solid #f1f5f9;">
                                <th style="padding: 12px;">Driver Name</th>
                                <th style="padding: 12px;">Phone Number</th>
                                <th style="padding: 12px;">Plate Number</th>
                                <th style="padding: 12px;">Status</th>
                                <th style="padding: 12px;">Rating</th>
                                <th style="padding: 12px;">Verification</th>
                                <th style="padding: 12px;">Action</th>
                            </tr>
                        </thead>
                        <tbody id="drivers-table-body">
                            <!-- Drivers will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Users Management View -->
        <div id="users-view" style="display: none;">
            <div class="card-panel" style="width: 100%;">
                <h2>User Management</h2>
                <div class="table-container">
                    <table style="width: 100%; border-collapse: collapse; text-align: left;">
                        <thead>
                            <tr style="border-bottom: 2px solid #f1f5f9;">
                                <th style="padding: 12px;">Name</th>
                                <th style="padding: 12px;">Email</th>
                                <th style="padding: 12px;">Role</th>
                                <th style="padding: 12px;">Joined Date</th>
                            </tr>
                        </thead>
                        <tbody id="users-table-body">
                            <!-- Users will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Emergencies Management View -->
        <div id="emergencies-view" style="display: none;">
            <div class="card-panel" style="width: 100%;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                    <h2>Emergency SOS Logs</h2>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <button onclick="deleteAllResolvedEmergencies()"
                            style="background: #f1f5f9; color: #475569; border: 1px solid #e2e8f0; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 600; display: flex; align-items: center; gap: 6px;">
                            <i class='bx bx-trash' style="font-size: 16px;"></i> Clear All Resolved
                        </button>
                        <span class="badge badge-danger">High Priority Live Monitoring</span>
                    </div>
                </div>
                <div class="table-container">
                    <table style="width: 100%; border-collapse: collapse; text-align: left;">
                        <thead>
                            <tr style="border-bottom: 2px solid #f1f5f9;">
                                <th style="padding: 12px;">Time</th>
                                <th style="padding: 12px;">Passenger</th>
                                <th style="padding: 12px;">Driver / Vehicle</th>
                                <th style="padding: 12px;">Guardian</th>
                                <th style="padding: 12px;">Status</th>
                                <th style="padding: 12px;">Action</th>
                            </tr>
                        </thead>
                        <tbody id="emergencies-table-body">
                            <!-- SOS logs will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Broadcasting View -->
        <div id="broadcast-view" style="display: none;">
            <div class="card-panel">
                <h2><i class='bx bx-broadcast'></i> Send City-Wide Alert</h2>
                <p style="color: var(--text-muted); margin-bottom: 20px;">Send a message to all active drivers in
                    Dumaguete City.</p>

                <div class="modal-form-group">
                    <label>Alert Title</label>
                    <input type="text" id="broadcast-title" class="modal-input"
                        placeholder="e.g. Road Closure: Rizal Blvd">
                </div>
                <div class="modal-form-group">
                    <label>Message Detail</label>
                    <textarea id="broadcast-message" class="modal-input"
                        style="height: 100px; resize: none; padding: 12px;"
                        placeholder="Enter details for the drivers..."></textarea>
                </div>
                <div class="modal-form-group">
                    <label>Alert Type</label>
                    <select id="broadcast-type" class="modal-input">
                        <option value="info">Information (Blue)</option>
                        <option value="success">Success (Green)</option>
                        <option value="warning">Warning (Orange)</option>
                        <option value="danger">Danger/Urgent (Red)</option>
                    </select>
                </div>

                <button id="broadcast-send-btn" onclick="sendBroadcast()" class="btn-confirm"
                    style="padding: 12px 24px; border: none; border-radius: 12px; cursor: pointer; font-weight: 600; width: 100%;">
                    <i class='bx bx-paper-plane'></i> SEND ALERT TO ALL DRIVERS
                </button>

                <div id="broadcast-status" style="margin-top: 15px; text-align: center; color: #10b981; display: none;">
                    <i class='bx bx-check-circle'></i> Alert sent successfully!
                </div>
            </div>

            <div class="card-panel" style="margin-top: 32px;">
                <h2>Recent Broadcasts</h2>
                <div id="recent-broadcasts-list">
                    <p style="text-align: center; color: var(--text-muted); padding: 20px;">Loading history...</p>
                </div>
            </div>
        </div>
        </div>
    </main>

    <!-- Verification Modal -->
    <div id="verifyModal" class="modal-overlay">
        <div class="modal-card">
            <h2>Verify Driver</h2>
            <div class="modal-form-group">
                <label>TMO Permit Number</label>
                <input type="text" id="modal-permit" class="modal-input" placeholder="DGT-2026-XXXX">
            </div>
            <div class="modal-form-group">
                <label>Registration Zone / Group</label>
                <input type="text" id="modal-zone" class="modal-input" placeholder="e.g. Zone 1 - Downtown">
            </div>
            <div class="modal-form-group">
                <label>Inspection Date</label>
                <input type="date" id="modal-inspection" class="modal-input">
            </div>
            <input type="hidden" id="modal-driver-id">
            <div class="modal-actions">
                <button class="modal-btn btn-cancel" onclick="closeVerifyModal()">Cancel</button>
                <button class="modal-btn btn-confirm" onclick="saveVerification()">Save & Verify</button>
            </div>
        </div>
    </div>

    <!-- Core Scripts -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- Leaflet Routing Machine JS -->
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>

    <script type="module" src="js/controller.js"></script>
</body>

</html>